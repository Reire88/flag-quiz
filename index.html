.    { iso2:"il", he:"×™×©×¨××œ", answers:["×™×©×¨××œ","israel"] },
    { iso2:"us", he:"××¨×¦×•×ª ×”×‘×¨×™×ª", answers:["××¨×¦×•×ª ×”×‘×¨×™×ª","××¨×¦×•×ª ×”×‘×¨×™×ª ×©×œ ×××¨×™×§×”","×××¨×™×§×”","usa","united states","united states of america","××¨×”×‘","××¨×” ×‘"] },
    { iso2:"fr", he:"×¦×¨×¤×ª", answers:["×¦×¨×¤×ª","france"] },
    { iso2:"de", he:"×’×¨×× ×™×”", answers:["×’×¨×× ×™×”","germany","deutschland"] },
    { iso2:"it", he:"××™×˜×œ×™×”", answers:["××™×˜×œ×™×”","italy"] },
    { iso2:"es", he:"×¡×¤×¨×“", answers:["×¡×¤×¨×“","spain","espaÃ±a","espana"] },
    { iso2:"gb", he:"×”×××œ×›×” ×”×××•×—×“×ª", answers:["×‘×¨×™×˜× ×™×”","×”×××œ×›×” ×”×××•×—×“×ª","×× ×’×œ×™×”","uk","united kingdom","britain","england"] },
    { iso2:"jp", he:"×™×¤×Ÿ", answers:["×™×¤×Ÿ","japan"] },
    { iso2:"br", he:"×‘×¨×–×™×œ", answers:["×‘×¨×–×™×œ","brazil"] },
    { iso2:"ca", he:"×§× ×“×”", answers:["×§× ×“×”","canada"] },
    { iso2:"mx", he:"××§×¡×™×§×•", answers:["××§×¡×™×§×•","mexico"] },
    { iso2:"gr", he:"×™×•×•×Ÿ", answers:["×™×•×•×Ÿ","greece"] },
    { iso2:"au", he:"××•×¡×˜×¨×œ×™×”", answers:["××•×¡×˜×¨×œ×™×”","australia"] },
    { iso2:"in", he:"×”×•×“×•", answers:["×”×•×“×•","india"] },
    { iso2:"cn", he:"×¡×™×Ÿ", answers:["×¡×™×Ÿ","china"] },
    { iso2:"eg", he:"××¦×¨×™×", answers:["××¦×¨×™×","egypt"] },
  ];

  function shuffle(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function pick10Unique(list){ return shuffle(list).slice(0,10); }

  function normalizeText(s){
    return (s||"").toLowerCase().trim()
      .replace(/[.,!?:;\-_/|"'()\[\]{}]/g," ")
      .replace(/[ \t\r\n]+/g," ");
  }

  // --- "×¡×œ×—× ×•×ª" ×œ×“×™×‘×•×¨ ×‘×¢×‘×¨×™×ª ---
  function normalizeHebrew(s){
    const noNikud=(s||"")
      .replace(/[Ö‘-×‡]/g,"") // × ×™×§×•×“/×˜×¢××™×
      .replace(/[×³×´]/g,"")
      .replace(/[\"'â€œâ€â€˜â€™`]/g,"");
    return normalizeText(noNikud)
      .replace(/×š/g,"×›").replace(/×/g,"×").replace(/×Ÿ/g,"× ").replace(/×£/g,"×¤").replace(/×¥/g,"×¦");
  }
  function stripSpaces(s){ return (s||"").replace(/ /g,""); }
  function levenshtein(a,b){
    a=a||""; b=b||"";
    if(a===b) return 0;
    const al=a.length, bl=b.length;
    if(!al) return bl; if(!bl) return al;
    const v0=new Array(bl+1), v1=new Array(bl+1);
    for(let i=0;i<=bl;i++) v0[i]=i;
    for(let i=0;i<al;i++){
      v1[0]=i+1;
      for(let j=0;j<bl;j++){
        const cost=a[i]===b[j]?0:1;
        v1[j+1]=Math.min(v1[j]+1, v0[j+1]+1, v0[j]+cost);
      }
      for(let j=0;j<=bl;j++) v0[j]=v1[j];
    }
    return v1[bl];
  }
  function buildAnswerVariants(raw){
    const base=normalizeHebrew(raw);
    const set=new Set();
    if(!base) return set;
    set.add(base); set.add(stripSpaces(base));
    if(base.includes("××¨×¦×•×ª ×”×‘×¨×™×ª")){
      set.add(normalizeHebrew("××¨×”×‘"));
      set.add(normalizeHebrew("××¨×” ×‘"));
      set.add(stripSpaces(normalizeHebrew("××¨×”×‘")));
    }
    const stripped=base
      .replace(/^××“×™× ×ª[ ]+/g,"")
      .replace(/^×”×¨×¤×•×‘×œ×™×§×”[ ]+×©×œ[ ]+/g,"")
      .trim();
    if(stripped && stripped!==base){
      set.add(stripped); set.add(stripSpaces(stripped));
    }
    return set;
  }
  function isSpokenMatch(spoken, expectedVariants){
    const t=spoken; if(!t) return false;
    const ts=stripSpaces(t);
    for(const e of expectedVariants){
      if(!e) continue;
      if(t===e) return true;
      if(t.includes(e) || e.includes(t)) return true;
      const es=stripSpaces(e);
      if(ts && es && (ts===es || ts.includes(es) || es.includes(ts))) return true;
      const len=Math.max(ts.length, es.length);
      const maxEdits=len<=4?1:len<=8?2:3;
      if(len>=3 && levenshtein(ts,es)<=maxEdits) return true;
    }
    return false;
  }

  function scoreAnimal(score){
    const map=[
      {min:0,max:1,animal:"× ××œ×”",size:0.9},
      {min:2,max:3,animal:"×—×ª×•×œ",size:1.0},
      {min:4,max:5,animal:"×›×œ×‘",size:1.15},
      {min:6,max:7,animal:"×›×‘×©×”",size:1.3},
      {min:8,max:9,animal:"×¤×¨×”",size:1.5},
      {min:10,max:10,animal:"×¤×™×œ",size:1.8},
    ];
    return map.find(m=>score>=m.min && score<=m.max) || map[0];
  }

  // --- Speech Recognition ---
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const supported = !!SR;
  const rec = supported ? new SR() : null;
  if(rec){
    rec.lang="he-IL";
    rec.interimResults=false;
    rec.maxAlternatives=5;
  }

  // --- State ---
  let phase="start"; // start|quiz|result
  let round=pick10Unique(COUNTRIES);
  let idx=0, score=0;
  let listening=false;
  let feedback=null; // {ok, he}
  let lastHeard="";
  let errorMsg="";

  const app = document.getElementById("app");

  function render(){
    if(phase==="start"){
      app.innerHTML = `
        <div style="font-size:18px;font-weight:800;margin-bottom:6px">××•×›× ×™×?</div>
        <div class="muted">×‘×›×œ ×¡×™×‘×•×‘ ×™×© <b>10 ×©××œ×•×ª</b>. ×‘×›×œ ×©××œ×” ××•×¦×’ ×“×’×œ. ×××•×¨/×™ ×‘×§×•×œ ××ª ×©× ×”××“×™× ×”.</div>
        ${!supported ? `<div class="fb" style="background:#fff3cd">×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×–×™×”×•×™ ×“×™×‘×•×¨. ××•××œ×¥ Chrome ×‘×× ×“×¨×•××™×“.</div>` : ``}
        <button class="btn btnPrimary" style="width:100%;margin-top:14px" onclick="startRound()">×”×ª×—×œ ×¡×™×‘×•×‘</button>
      `;
      return;
    }

    if(phase==="quiz"){
      const c = round[idx];
      const url = `https://flagcdn.com/w640/${c.iso2}.png`;
      app.innerHTML = `
        <div class="row" style="margin-bottom:10px">
          <span class="pill">×©××œ×” ${idx+1} / 10</span>
          <span class="pill">× ×™×§×•×“: ${score}</span>
        </div>

        <img src="${url}" alt="Flag ${c.he}" onerror="onImgError()" />

        ${errorMsg ? `<div class="fb" style="background:#ffe9ea;color:#b00020;margin-top:10px">${errorMsg}</div>` : ``}

        <div class="card" style="box-shadow:none;padding:0;margin-top:12px">
          <div class="muted">×œ×—×¥/×™ â€œ×”×ª×—×œ ×œ×“×‘×¨â€ ×•×××•×¨/×™ ×‘×§×•×œ ××ª ×©× ×”××“×™× ×”.</div>

          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn btnPrimary" ${(!supported || listening || feedback) ? "disabled":""} onclick="startListening()">
              ${listening ? "××§×©×™×‘â€¦" : "×”×ª×—×œ ×œ×“×‘×¨"}
            </button>
            <button class="btn btnGhost" ${(!supported || !listening) ? "disabled":""} onclick="stopListening()">×¢×¦×•×¨</button>
          </div>

          ${lastHeard ? `<div class="heard">×©××¢×ª×™: <b style="color:#111">${escapeHtml(lastHeard)}</b></div>` : ``}

          ${feedback ? `
            <div class="fb" style="margin-top:12px">
              <div class="big ${feedback.ok ? "ok":"bad"}">${feedback.ok ? "× ×›×•×Ÿ" : "×œ× × ×›×•×Ÿ"}</div>
              <div style="font-size:18px;font-weight:800;margin-top:2px">${feedback.he}</div>
            </div>
          `:``}
        </div>
      `;
      return;
    }

    if(phase==="result"){
      const a=scoreAnimal(score);
      const w = Math.round(96*a.size), h = Math.round(96*a.size);
      app.innerHTML = `
        <div style="font-size:18px;font-weight:800">×¡×™×™×× ×•!</div>
        <div class="big" style="margin-top:6px">${score} / 10</div>

        <div class="fb" style="margin-top:14px">
          <div class="animalBox">
            <div>
              <div class="muted">×”×—×™×” ×©×œ×š</div>
              <div style="font-size:24px;font-weight:900">${a.animal}</div>
              <div class="muted">(×›×¨×’×¢ ×“××• â€” ××¤×©×¨ ×œ×”×—×œ×™×£ ×œ×ª××•× ×”)</div>
            </div>
            <div class="animalPaw" style="width:${w}px;height:${h}px">
              <div style="font-size:34px">ğŸ¾</div>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:14px">
          <button class="btn btnPrimary" style="flex:1" onclick="startRound()">×¡×™×‘×•×‘ × ×•×¡×£</button>
          <button class="btn btnGhost" onclick="goHome()">×—×–×¨×”</button>
        </div>
      `;
    }
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  window.startRound = function(){
    errorMsg=""; lastHeard=""; feedback=null;
    round = pick10Unique(COUNTRIES);
    idx=0; score=0;
    phase="quiz";
    render();
  };
  window.goHome = function(){ phase="start"; render(); };

  window.onImgError = function(){
    errorMsg="×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ×“×’×œ. ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.";
    render();
  };

  window.startListening = function(){
    if(!supported) return;
    errorMsg=""; feedback=null; lastHeard="";
    try{
      listening=true;
      render();
      rec.onresult = (e)=>{
        const alts=[];
        for(let i=0;i<e.results.length;i++){
          const r=e.results[i];
          for(let j=0;j<r.length;j++){
            alts.push({t:r[j].transcript, conf:r[j].confidence});
          }
        }
        const c=round[idx];

        const normalizedHebAlts = alts.map(a=>normalizeHebrew(a.t)).filter(Boolean);
        lastHeard = normalizedHebAlts[0] || "";
        const expected = new Set();
        c.answers.forEach(ans => buildAnswerVariants(ans).forEach(v=>expected.add(v)));
        buildAnswerVariants(c.he).forEach(v=>expected.add(v));

        const ok = normalizedHebAlts.some(t => isSpokenMatch(t, expected));
        feedback = { ok, he: c.he };
        if(ok) score++;

        listening=false;
        render();

        setTimeout(()=>{
          feedback=null; lastHeard="";
          if(idx>=9){ phase="result"; }
          else { idx++; }
          render();
        }, 900);
      };

      rec.onerror = (e)=>{
        listening=false;
        errorMsg = (e && e.error==="not-allowed")
          ? "××™×Ÿ ×’×™×©×” ×œ××™×§×¨×•×¤×•×Ÿ. ×ª×Ÿ ×”×¨×©××” ×œ-Chrome."
          : "×©×’×™××” ×‘×–×™×”×•×™ ×”×“×™×‘×•×¨. × ×¡×” ×©×•×‘.";
        render();
      };

      rec.onend = ()=>{
        listening=false;
        render();
      };

      rec.start();
    }catch(err){
      listening=false;
      errorMsg="×œ× ×”×¦×œ×—×ª×™ ×œ×”×ª×—×™×œ ×”×§×œ×˜×” (××•×œ×™ ×œ×—×¦×ª ×¤×¢××™×™×). × ×¡×” ×©×•×‘.";
      render();
    }
  };

  window.stopListening = function(){
    if(!supported) return;
    try{ rec.stop(); }catch(e){}
  };

  render();
</script>
</body>
</html>
